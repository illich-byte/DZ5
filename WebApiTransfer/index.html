<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управління Містами (Firestore)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .action-icon {
            width: 20px;
            height: 20px;
            min-width: 20px;
        }

        .detail-card {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
        }

        .detail-header {
            background-color: #4f46e5;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-body {
            padding: 1.5rem;
        }

        .detail-item {
            display: flex;
            margin-bottom: 0.75rem;
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-label {
            font-weight: 600;
            color: #4b5563;
            width: 100%;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            color: #1f2937;
            flex-grow: 1;
        }

        @media (min-width: 640px) {
            .detail-item {
                flex-direction: row;
                align-items: center;
            }

            .detail-label {
                width: 150px;
                margin-bottom: 0;
            }
        }

        .tox-tinymce {
            border-radius: 0.5rem !important;
        }
    </style>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, getDoc, query, serverTimestamp, enableIndexedDbPersistence, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.unsubscribeFromCities = null;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.isAuthReady = true;
                        console.log("Firebase: User signed in. UID:", window.userId);
                        window.loadCitiesAndRender();
                    } else {
                        window.userId = null;
                        window.isAuthReady = true;
                        console.log("Firebase: User signed out or failed to sign in.");
                        window.renderCityList([]);
                    }
                });

            } catch (error) {
                console.error("Помилка ініціалізації Firebase:", error);
                window.isAuthReady = true;
                window.showMessage(`Помилка підключення до бази даних: ${error.message}`, 'error');
            }
        }

        window.getCityCollectionRef = function () {
            if (!window.db || !window.userId) return null;
            const collectionPath = `artifacts/${appId}/users/${window.userId}/cities`;
            return collection(window.db, collectionPath);
        };

        initializeFirebase();
    </script>
    <script>
        function initTinyMCE() {
            tinymce.init({
                selector: '#description',
                height: 300,
                plugins: 'lists link code autoresize',
                toolbar: 'bold italic underline | bullist numlist | link | code',
                menubar: false,
                statusbar: false,
                content_style: 'body { font-family: Inter, Arial, sans-serif; font-size:16px }',
            });
        }
    </script>
</head>
<body>

    <div class="p-4 sm:p-8 min-h-screen">
        <div class="max-w-6xl mx-auto">
            <div id="user-info" class="mb-4 p-3 bg-indigo-50 text-indigo-800 text-xs rounded-lg shadow">
                Очікування аутентифікації...
            </div>

            <header class="mb-8 flex justify-between items-center bg-white p-4 rounded-xl shadow-lg">
                <h1 class="text-xl sm:text-3xl font-bold text-gray-900">
                    Управління Містами
                </h1>
                <button id="create-city-btn"
                        class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center text-sm"
                        disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="action-icon mr-1"><path d="M5 12h14" /><path d="M12 5v14" /></svg>
                    Створити
                </button>
            </header>

            <div id="city-list-container" class="bg-white rounded-xl shadow-2xl overflow-hidden">
                <div id="loading-spinner" class="p-12 text-center text-indigo-600">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-t-transparent border-indigo-500 rounded-full" role="status"></div>
                    <p class="mt-3">Очікування підключення до бази даних...</p>
                </div>
            </div>

            <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-xl hidden transition-opacity duration-300 z-50"></div>

        </div>
    </div>

    <div id="city-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-40 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95 opacity-0">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Створити Нове Місто</h2>
            <form id="city-form">
                <input type="hidden" id="city-doc-id" value="">

                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Назва Міста *</label>
                    <input type="text" id="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Наприклад, Львів">
                </div>

                <div class="mb-4">
                    <label for="slug" class="block text-sm font-medium text-gray-700 mb-1">Slug (URL-адреса) *</label>
                    <input type="text" id="slug" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Наприклад, lviv">
                </div>

                <div class="mb-4">
                    <label for="countryId" class="block text-sm font-medium text-gray-700 mb-1">Країна *</label>
                    <select id="countryId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>Завантаження країн...</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Опис</label>
                    <textarea id="description" rows="3" placeholder="Короткий опис міста..."></textarea>
                </div>

                <div class="mb-6">
                    <label for="imageLink" class="block text-sm font-medium text-gray-700 mb-1">Посилання на Зображення</label>
                    <input type="url" id="imageLink" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="http://example.com/image.jpg">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-100 transition duration-150">
                        Скасувати
                    </button>
                    <button type="submit" id="save-city-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        Зберегти Місто
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="detail-card transform transition-all duration-300 scale-95 opacity-0">
            <div class="detail-header">
                <h2 id="detail-title" class="text-xl font-semibold">Деталі Міста</h2>
                <button onclick="closeDetailModal()" class="text-white hover:text-indigo-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="action-icon"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.3 14.7L12 13.4l-3.3 3.3-1.4-1.4L10.6 12 7.3 8.7l1.4-1.4L12 10.6l3.3-3.3 1.4 1.4L13.4 12l3.3 3.3-1.4 1.4z" /></svg>
                </button>
            </div>
            <div class="detail-body">
                <div id="detail-content">
                    <div class="text-center py-6 text-gray-500">Завантаження деталей...</div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { doc, onSnapshot, setDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const mockCountries = [
            { id: 1, name: 'Україна' },
            { id: 2, name: 'Польща' },
            { id: 3, name: 'Німеччина' },
        ];

        function getCountryNameById(id) {
            const country = mockCountries.find(c => c.id === id);
            return country ? country.name : 'Невідома країна';
        }

        const cityModal = document.getElementById('city-modal');
        const modalTitle = document.getElementById('modal-title');
        const cityForm = document.getElementById('city-form');
        const cityDocIdInput = document.getElementById('city-doc-id');
        const nameInput = document.getElementById('name');
        const slugInput = document.getElementById('slug');
        const countryIdSelect = document.getElementById('countryId');
        const descriptionTextarea = document.getElementById('description');
        const imageLinkInput = document.getElementById('imageLink');
        const detailModal = document.getElementById('detail-modal');
        const detailModalContent = document.getElementById('detail-content');
        const detailModalTitle = document.getElementById('detail-title');
        const cityListContainer = document.getElementById('city-list-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const createCityBtn = document.getElementById('create-city-btn');
        const userInfoDiv = document.getElementById('user-info');
        const messageBox = document.getElementById('message-box');

        window.showMessage = function (message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50';

            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else {
                messageBox.classList.add('bg-red-600');
            }

            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('opacity-100'), 10);
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        function populateCountriesDropdown() {
            countryIdSelect.innerHTML = '<option value="" disabled selected>Виберіть країну</option>';
            countryIdSelect.disabled = false;

            mockCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = country.name;
                countryIdSelect.appendChild(option);
            });
        }

        window.openModal = function () {
            populateCountriesDropdown();
            if (tinymce.get('description')) {
                tinymce.get('description').setContent('');
            } else {
                window.initTinyMCE();
            }

            cityModal.classList.remove('hidden');
            setTimeout(() => {
                cityModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                cityModal.querySelector('div').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeModal = function () {
            cityModal.querySelector('div').classList.remove('scale-100', 'opacity-100');
            cityModal.querySelector('div').classList.add('scale-95', 'opacity-0');

            if (tinymce.get('description')) {
                tinymce.get('description').remove();
            }

            setTimeout(() => {
                cityModal.classList.add('hidden');
                cityForm.reset();
                cityDocIdInput.value = '';
                modalTitle.textContent = 'Створити Нове Місто';
            }, 300);
        }

        window.openDetailModal = function () {
            detailModal.classList.remove('hidden');
            setTimeout(() => {
                detailModal.querySelector('.detail-card').classList.remove('scale-95', 'opacity-0');
                detailModal.querySelector('.detail-card').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeDetailModal = function () {
            detailModal.querySelector('.detail-card').classList.remove('scale-100', 'opacity-100');
            detailModal.querySelector('.detail-card').classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                detailModal.classList.add('hidden');
                detailModalContent.innerHTML = '<div class="text-center py-6 text-gray-500">Завантаження деталей...</div>';
            }, 300);
        }

        function createCityRow(city) {
            const viewIcon = '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>';
            const editIcon = '<path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>';
            const deleteIcon = '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>';

            const renderIcon = (pathData) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="action-icon">${pathData}</svg>`;

            return `
                    <tr class="hover:bg-gray-50 transition duration-150" data-city-id="${city.docId}">
                        <td class="px-4 py-3 sm:px-6 whitespace-nowrap text-sm font-mono bg-gray-50 text-gray-900">${city.docId.substring(0, 8)}...</td>
                        <td class="px-4 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-700">
                            <div class="font-semibold">${city.name}</div>
                        </td>
                        <td class="px-4 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${city.slug}</td>
                        <td class="px-4 py-3 sm:px-6 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell">${getCountryNameById(city.countryId)}</td>
                        <td class="px-4 py-3 sm:px-6 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-1 sm:space-x-2">
                                <button onclick="handleView('${city.docId}')" class="text-indigo-600 hover:text-indigo-900 p-1 rounded hover:bg-indigo-50 transition duration-150" title="Переглянути деталі">
                                    ${renderIcon(viewIcon)}
                                </button>
                                <button onclick="handleEdit('${city.docId}')" class="text-yellow-600 hover:text-yellow-900 p-1 rounded hover:bg-yellow-50 transition duration-150" title="Редагувати">
                                    ${renderIcon(editIcon)}
                                </button>
                                <button onclick="handleDelete('${city.docId}', '${city.name}')" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition duration-150" title="Видалити">
                                    ${renderIcon(deleteIcon)}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        }

        window.renderCityList = function (cities) {

            userInfoDiv.innerHTML = `
                    <span class="font-bold">UID:</span> ${window.userId || 'Не авторизовано'}
                    <span class="ml-4 font-bold">Кількість міст:</span> ${cities.length}
                `;

            createCityBtn.disabled = !window.userId;

            if (cities.length === 0) {
                cityListContainer.innerHTML = `
                        <div class="p-12 text-center bg-yellow-50 text-yellow-800 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2">Немає збережених міст</h3>
                            <p>Натисніть "Створити", щоб додати перше місто у вашу базу даних Firestore.</p>
                        </div>
                    `;
                return;
            }

            const tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 sm:px-6 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Doc ID</th>
                                    <th scope="col" class="px-4 py-3 sm:px-6 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Назва Міста</th>
                                    <th scope="col" class="px-4 py-3 sm:px-6 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider hidden sm:table-cell">Slug</th>
                                    <th scope="col" class="px-4 py-3 sm:px-6 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider hidden md:table-cell">Країна</th>
                                    <th scope="col" class="relative px-4 py-3 sm:px-6"><span class="sr-only">Дії</span></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${cities.map(createCityRow).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            cityListContainer.innerHTML = tableHtml;
        }

        function renderCityDetails(city) {
            const date = city.updatedAt && city.updatedAt.toDate ? city.updatedAt.toDate() : new Date();
            const formattedDate = date.toLocaleString('uk-UA', { dateStyle: 'medium', timeStyle: 'short' });

            detailModalContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center mb-4">
                            <img src="${city.imageLink || 'https://placehold.co/150x100/AAAAAA/FFFFFF?text=No+Image'}"
                                 onerror="this.onerror=null;this.src='https://placehold.co/150x100/AAAAAA/FFFFFF?text=No+Image';"
                                 alt="Зображення міста ${city.name}" class="rounded-lg mx-auto shadow-md max-w-full h-auto">
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Doc ID:</span>
                            <span class="detail-value font-mono bg-gray-100 px-2 py-1 rounded text-sm">${city.docId}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Назва:</span>
                            <span class="detail-value font-semibold">${city.name}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Країна:</span>
                            <span class="detail-value">${getCountryNameById(city.countryId)} (ID: ${city.countryId})</span>
                        </div>
                        <div class="detail-item flex-col !items-start">
                            <span class="detail-label">Опис:</span>
                            <div class="detail-value mt-1 p-2 border border-gray-200 rounded w-full bg-gray-50">${city.description || 'Опис відсутній.'}</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Останнє оновлення:</span>
                            <span class="detail-value">${formattedDate}</span>
                        </div>
                    </div>
                `;
            detailModalTitle.textContent = `Деталі Міста: ${city.name}`;
        }

        window.loadCitiesAndRender = function () {
            if (!window.isAuthReady) {
                loadingSpinner.querySelector('p').textContent = 'Очікування підключення до бази даних...';
                return;
            }

            loadingSpinner.classList.remove('hidden');
            loadingSpinner.querySelector('p').textContent = 'Синхронізація даних...';

            const cityCollectionRef = window.getCityCollectionRef();
            if (!cityCollectionRef) {
                loadingSpinner.classList.add('hidden');
                window.renderCityList([]);
                return;
            }

            if (window.unsubscribeFromCities) {
                window.unsubscribeFromCities();
            }

            window.unsubscribeFromCities = onSnapshot(cityCollectionRef, (snapshot) => {
                const cities = [];
                snapshot.forEach(doc => {
                    cities.push({
                        docId: doc.id,
                        ...doc.data()
                    });
                });

                loadingSpinner.classList.add('hidden');
                window.renderCityList(cities);
                console.log("Firestore: Дані оновлено в реальному часі.", cities);
            }, (error) => {
                loadingSpinner.classList.add('hidden');
                console.error("Помилка onSnapshot:", error);
                cityListContainer.innerHTML = `
                        <div class="p-12 text-center bg-red-50 text-red-800 rounded-xl">
                            <h3 class="text-xl font-semibold mb-2">Помилка Синхронізації</h3>
                            <p>Не вдалося синхронізувати список міст: ${error.message}</p>
                        </div>
                    `;
                window.showMessage(`Критична помилка синхронізації: ${error.message}`, 'error');
            });
        };

        async function getCityDetailByDocId(docId) {
            const cityCollectionRef = window.getCityCollectionRef();
            if (!cityCollectionRef) throw new Error("База даних не ініціалізована.");

            const cityDocRef = doc(cityCollectionRef, docId);
            const citySnapshot = await getDoc(cityDocRef);

            if (citySnapshot.exists()) {
                return { docId: citySnapshot.id, ...citySnapshot.data() };
            } else {
                throw new Error(`Місто з ID ${docId} не знайдено (404).`);
            }
        }

        window.handleDelete = function (docId, cityName) {
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50';
            confirmationModal.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4">
                        <h3 class="text-xl font-bold mb-4 text-red-600">Підтвердження Видалення</h3>
                        <p class="mb-6">Ви впевнені, що хочете видалити місто <strong>"${cityName}"</strong>?</p>
                        <div class="flex justify-end space-x-3">
                            <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-100 transition duration-150">
                                Скасувати
                            </button>
                            <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                                Видалити
                            </button>
                        </div>
                    </div>
                `;
            document.body.appendChild(confirmationModal);

            document.getElementById('cancel-delete').onclick = () => document.body.removeChild(confirmationModal);
            document.getElementById('confirm-delete').onclick = async () => {
                document.body.removeChild(confirmationModal);
                await executeDelete(docId, cityName);
            };
        }

        async function executeDelete(docId, cityName) {
            try {
                const cityCollectionRef = window.getCityCollectionRef();
                if (!cityCollectionRef) throw new Error("База даних не ініціалізована.");

                await deleteDoc(doc(cityCollectionRef, docId));
                window.showMessage(`Місто "${cityName}" успішно видалено.`, 'success');
            } catch (error) {
                window.showMessage(`Помилка видалення: ${error.message}`, 'error');
            }
        }

        window.handleView = async function (docId) {
            window.openDetailModal();
            detailModalContent.innerHTML = '<div class="text-center py-6 text-indigo-600"><div class="animate-spin inline-block w-6 h-6 border-3 border-t-transparent border-indigo-500 rounded-full"></div><p class="mt-2">Завантаження...</p></div>';

            try {
                const city = await getCityDetailByDocId(docId);
                window.renderCityDetails(city);
            } catch (error) {
                window.closeDetailModal();
                window.showMessage(`Помилка: ${error.message}`, 'error');
            }
        }

        window.handleEdit = async function (docId) {
            try {
                const city = await getCityDetailByDocId(docId);

                cityDocIdInput.value = city.docId;
                nameInput.value = city.name;
                slugInput.value = city.slug;
                imageLinkInput.value = city.imageLink || '';

                window.openModal();

                countryIdSelect.value = city.countryId.toString();

                tinymce.get('description').setContent(city.description || '');

                modalTitle.textContent = `Редагування Міста: ${city.name}`;
            } catch (error) {
                window.showMessage(`Помилка завантаження даних для редагування: ${error.message}`, 'error');
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const docId = cityDocIdInput.value;
            const isEditing = docId !== '';

            const descriptionContent = tinymce.get('description') ? tinymce.get('description').getContent() : descriptionTextarea.value;

            if (!countryIdSelect.value) {
                window.showMessage("Будь ласка, виберіть країну.", 'error');
                return;
            }

            const cityData = {
                name: nameInput.value.trim(),
                slug: slugInput.value.trim(),
                countryId: parseInt(countryIdSelect.value),
                description: descriptionContent.trim() || null,
                imageLink: imageLinkInput.value.trim() || null,
                updatedAt: serverTimestamp()
            };

            window.closeModal();

            try {
                const cityCollectionRef = window.getCityCollectionRef();
                if (!cityCollectionRef) throw new Error("База даних не ініціалізована.");

                if (isEditing) {
                    await setDoc(doc(cityCollectionRef, docId), cityData, { merge: true });
                    window.showMessage(`Місто "${cityData.name}" успішно оновлено!`, 'success');
                } else {
                    await setDoc(doc(cityCollectionRef), cityData);
                    window.showMessage(`Місто "${cityData.name}" успішно створено!`, 'success');
                }
            } catch (error) {
                window.showMessage(`Помилка операції: ${error.message}`, 'error');
                console.error("Firestore Error:", error);
            }
        }

        document.getElementById('create-city-btn').addEventListener('click', () => {
            cityForm.reset();
            cityDocIdInput.value = '';
            modalTitle.textContent = 'Створити Нове Місто';
            window.openModal();
        });

        cityForm.addEventListener('submit', handleFormSubmit);

        window.renderCityDetails = renderCityDetails;

    </script>
</body>
</html>